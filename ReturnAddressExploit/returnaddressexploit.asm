section .data
    out_str1    db "Please enter your name: ", 0
    out_str2    db "Hello %s", 0xa, 0
    exploit_str db "expl0ited", 0xa, 0

section .text

extern printf
extern gets
extern puts

global main
global f1
global f2

  ;; This script will use a gets bufferoverflow to overwrite the return address
  ;; from f1 and return to f2.
  ;; f1 uses gets with the basepointer as first argument. To use the exploit,
  ;; we need to overwrite the first 8 bytes (the old base pointer) with some
  ;; garbage and then overwrite the old return address with the address of f2
  ;; (0x400550)

f2:
    push        rbp
    mov         rbp, rsp

    mov         rdi, exploit_str
    call        puts

    pop         rbp
    ret

f1:
    push        rbp
    mov         rbp, rsp
    sub         rsp, 16    ; Reserve 16 bytes on the stack for the name

    mov         rdi, out_str1
    call        printf

    mov         rdi, rsp
    call        gets

    mov         rdi, out_str2
    mov         rsi, rsp
    call        printf

    add         rsp, 16
    pop         rbp
    ret

main:
    push        rbp
    mov         rbp, rsp

    call        f1

    pop         rbp
    ret
